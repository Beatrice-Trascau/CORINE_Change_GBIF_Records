---
title: "glmms_land_cover_change(y/n)_and_occurrences"
author: "Beatrice Trascau"
date: "2024-05-31"
output: html_document
---

# **3.1. GLMMS: Land Cover Change (Y/N) and Occurrence Records**

This markdown outlines the process of modelling the number of species occurrence records in relation to land cover changes, time and SSB ID.

```{r library load, include = FALSE}
library(here)
library(dplyr)
library(lattice)
library(lme4)
library(DHARMa)
library(glmmTMB)
library(mgcv)
library(gamm4)
library(ggplot2)
```

```{r data load, include = FALSE, eval = FALSE}
load(here("data", "derived_data", "occurrences_SSB_municipalities_land_cover.rda"))
occ_SSB_land_cover <- occurrence_municipalities_df
```

```{r prepare df for analyis, include = FALSE, eval = FALSE}

# 1. First period of change: 2000-2006 -------------------------------------------------

# Change column names for easier df manipulation
occ_SSB_land_cover <- occ_SSB_land_cover |>
  rename(land_cover2000 = U2006_CLC2000_V2020_20u1,
         land_cover2006 = U2012_CLC2006_V2020_20u1,
         land_cover2012 = U2018_CLC2012_V2020_20u1,
         land_cover2018 = U2018_CLC2018_V2020_20u1)

# Prepare data for the period 2006-2009
occ_df_after_2000.2006 <- occ_SSB_land_cover |>
  select(V1, gbifID, year, species, land_cover2000, land_cover2006, 
         SSBID, cell_ID, NAME_2) |>
  filter(!is.na(land_cover2000) & !is.na(land_cover2006)) |>
  filter(year >= 2006 & year <= 2009) |>
  mutate(cover_change = if_else(land_cover2000 == land_cover2006, "N", "Y"))

# Calculate number of records for the period 2006-2009
occ_df_after_2000.2006_records <- occ_df_after_2000.2006 |>
  group_by(cell_ID) |>
  summarise(
    ocurrences_after = n(),
    land_cover2000 = first(land_cover2000),
    land_cover2006 = first(land_cover2006),
    cover_change = first(cover_change),
    SSBID = first(SSBID),
    NAME_2 = first(NAME_2)) |>
  mutate(time_period = "2000-2006") |>
  select(-c(land_cover2000, land_cover2006))

# 2. Second period of change: 2006 - 2012 ----------------------------------------------

# Prepare data for the period 2012-2015
occ_df_after_2006.2012 <- occ_SSB_land_cover |>
  select(V1, gbifID, year, species, land_cover2006, land_cover2012, 
         SSBID, cell_ID, NAME_2) |>
  filter(!is.na(land_cover2006) & !is.na(land_cover2012)) |>
  filter(year >= 2012 & year <= 2015) |>
  mutate(cover_change = if_else(land_cover2006 == land_cover2012, "N", "Y"))

# Calculate number of records for the period 2012-2015
occ_df_after_2006.2012_records <- occ_df_after_2006.2012 |>
  group_by(cell_ID) |>
  summarise(
    ocurrences_after = n(),
    land_cover2006 = first(land_cover2006),
    land_cover2012 = first(land_cover2012),
    cover_change = first(cover_change),
    SSBID = first(SSBID),
    NAME_2 = first(NAME_2)) |>
  mutate(time_period = "2006-2012") |>
  select(-c(land_cover2006, land_cover2012))

# 3. Third period of change: 2012 - 2018 ----------------------------------------------

# Prepare data for the period 2015-2018
occ_df_after_2012.2018 <- occ_SSB_land_cover |>
  select(V1, gbifID, year, species, land_cover2012, land_cover2018, 
         SSBID, cell_ID, NAME_2) |>
  filter(!is.na(land_cover2012) & !is.na(land_cover2018)) |>
  filter(year >= 2015 & year <= 2018) |>
  mutate(cover_change = if_else(land_cover2012 == land_cover2018, "N", "Y"))

# Calculate number of records for the period 1997-2000
occ_df_after_2012.2018_records <- occ_df_after_2012.2018 |>
  group_by(cell_ID) |>
  summarise(
    ocurrences_after = n(),
    land_cover2012 = first(land_cover2012),
    land_cover2018 = first(land_cover2018),
    cover_change = first(cover_change),
    SSBID = first(SSBID),
    NAME_2 = first(NAME_2)) |>
  mutate(time_period = "2012-2018") |>
  select(-c(land_cover2012, land_cover2018))

# 4. Combine the above 3 into a single df ----------------------------------------------

occ_y_n_cover_change_after_records_for_model <- bind_rows(occ_df_after_2000.2006_records,
                                  occ_df_after_2006.2012_records,
                                  occ_df_after_2012.2018_records) |>
  select(-cell_ID) |>
  rename(municipality = NAME_2)

# 5. Write dataframe to file -----------------------------------------------------------
save(occ_y_n_cover_change_after_records_for_model, 
     file = here::here("data", "derived_data",
                       "occ_y_n_cover_change_after_records_for_model.rda"))

```

## Data Exploration

### Inspect Data

```{r inspect data}

# Read in data
load(here::here("data", "derived_data",
                "occ_y_n_cover_change_after_records_for_model.rda"))

glimpse(occ_y_n_cover_change_after_records_for_model)
```

### Check for Outliers

```{r check outliers}

# Barplot of number of occurrences
ggplot(occ_y_n_cover_change_after_records_for_model , 
       aes(x = cover_change, y = ocurrences_after, fill = time_period))+
  geom_boxplot()+
  theme_classic()

  

```

There are some very clear outliers in the number of occurrence records, more so for the pixels where the land cover doesn't change.

### Check Normality

```{r check normality}

# Plot histogram of number of records by time period
occ_y_n_cover_change_after_records_for_model |>
  filter(ocurrences_after < 100) |>
  ggplot(aes(x = ocurrences_after)) +
  geom_histogram(binwidth = 2, position = "dodge", 
                 alpha = 0.4) +
  facet_grid(time_period ~ ., scales = "free") +
  theme_classic()
```

Could be either exponential or geometric distribution - but absolutely not normal.

```{r goodness of fit tests for  geometric distribution}

```

### Check Zero Inflation

```{r check zero inflation}

# Calculate % of rows with values of 0 for number of occurrences
100 * sum(occ_y_n_cover_change_after_records_for_model$ocurrences_after == 0) / nrow(occ_y_n_cover_change_after_records_for_model)
#suspicious
```

### Check for Collinearity

Covariates in model (cover change, SSB ID and time period) are all categorial. No need to check for collinearity between them.

### Check Relationships

```{r check relationships}

# Plot relationships
occ_y_n_cover_change_after_records_for_model |>
  ggplot(aes(x = time_period, y = ocurrences_after)) +
  geom_point() +
  facet_wrap(~cover_change) +
  theme_classic()


```

Relationships difficult to determine but seems that in the case of the pixels where there is land cover change, the relationship with time is not linear.

## Attempt 1: Model 1: Number of occurrences after change by land cover, time period and SSB ID - negative binomial

```{r model 1, include = FALSE, eval = FALSE}

# Run negative binomial model
model1_nb <- glmer.nb(ocurrences_after ~ cover_change * time_period + (1|municipality),                    data = occ_y_n_cover_change_after_records_for_model)

# Save model output to file to save time next time
save(model1_nb, file = here::here("data", "models", "model1_nb.RData"))
```

The model: ocurrences_after \~ cover_change \* time_period + (1\|SSBID) failed to converge: "Warning: Model failed to converge with max\|grad\| = 0.00724284 (tol = 0.002, component 1)Warning: Model is nearly unidentifiable: very large eigenvalue - Rescale variables?"

The model ocurrences_after \~ cover_change \* time_period + (1\|municipality) also failed to converge: "Warning: Model failed to converge with max\|grad\| = 0.00214456 (tol = 0.002, component 1)Warning: Model is nearly unidentifiable: very large eigenvalue - Rescale variables?"

### Model Validation

#### Convergence Check

```{r convergence check}

# Load model from file
load(here::here("data", "models", "model1_nb.RData"))

# Get summary of the model
summary(model1_nb)
```

Model output suggests a significant effect of time and a significant interaction between time period and land cover change (Y) but no significant effect of land cover. Some high correlation values between cover_change_Y and cover_change_Y:2006_2012 as well as cover_change_Y and cover_change_Y:2012_2018. But this is to be expected as cover_change_Y is nested into cover_change_Y:2006_2012 and cover_change_Y:2012_2018. Most residuals (from scaled residuals) are close to zero. But the maximum residual (= 534.64) is very large. The AIC and BIC values are also very large.

#### Simulate Residuals with DHARMa

```{r model residuals}

# Simulate residuals
model1_nb_simulation <- simulateResiduals(fittedModel = model1_nb)

# Plot simulated residuals
plot(model1_nb_simulation)
```

Simulated residuals deviate significantly from expectations, are overdispersed and have many outliers. The within-group deviations from uniformity are significant. Test for homogeneity of variance is significant.

#### Residuals Diagnostics

```{r residuals diagnostics}

# Perform residual diagnostics
testResiduals(model1_nb_simulation)

# Plot residuals
#plot(residuals(model1_nb))
```

Everything that could go be with theresiduals has gone wrong.

#### Check Random Effects

```{r random effects}

# Check distribution
#ranef(model1_nb)
```

#### Test for Overdispersion

```{r test for overdispersion}
testDispersion(model1_nb_simulation)
```

Residuals are significantly overdispersed.

#### Test for Zero-Inflation

```{r test for zero-inflation}
testZeroInflation(model1_nb_simulation)
```

Significant zero inflation. Attempting a zero-inflated negative binomial model to address these issues.

## Attempt 2: Model 1: Number of occurrences after change by land cover (Y/N) and SSB ID - zero inflated negative binomial

```{r model 2. include = FALSE, eval = FALSE}

# Run zero inflated negative binomial model
model2_nb_zero <- glmmTMB(ocurrences_after ~ cover_change * time_period + (1|SSBid),
                          ziformula = ~ 1,
                          family = nbinom1, 
                          data = occ_y_n_cover_change_after_records_for_model)

# Save model output to file to save time next time
save(model2_nb_zero, file = here::here("data", "models", "model2_nb_zero.RData"))
```

Run this with family = nbiom1 instead of family = nbiom2.

### Model Validation

#### Convergence Check

```{r convergence check}

# Load model from file
load(here::here("data", "models", "model2_nb_zero.RData"))

# Get summary of the model
summary(model2_nb_zero)
```

Model output suggests a significant effect of time and a significant interaction between time period and land cover change (Y) but no significant effect of land cover. AIC and BIC values still large. Dispersion parameter = 0.50.

#### Simulate Residuals with DHARMa

```{r residuals, include = FALSE}

# Simulate residuals 
model2_nb_zero_simulation <- simulateResiduals(fittedModel = model2_nb_zero)

# Plot simulated residuals
plot(model2_nb_zero_simulation)
```

Simulated residuals deviate significantly from expectations, are overdispersed and have many outliers. The within-group deviations from uniformity are significant. Test for homogeneity of variance is significant.

#### Test for Overdispersion

```{r test for overdipserison}
testDispersion(model2_nb_zero_simulation)
```

Test for overdispersion is significant.

#### Test for Zero-Inflation

```{r test for zero-inflation}
testZeroInflation(model2_nb_zero_simulation)
```

Test for zero inflation is significant. Clearly, this model is not usable either.

## Attempt 3: Model 1: Number of occurrences after change by land cover change (Y/N) and SSB ID - Non-zero inflated negative binomial with glmmTMB

```{r model 3. include = FALSE, eval = FALSE}

# Run negative binomial model
model3_nb <- glmmTMB(ocurrences_after ~ cover_change * time_period + (1|SSBID),
                          family = nbinom1, 
                          data = occ_y_n_cover_change_after_records_for_model)

# Save model output to file to save time next time
save(model3_nb, file = here::here("data", "models", "model3_nb.RData"))
```

### Model Validation

#### Convergence Check

```{r convergence check}

# Load model from file
load(here::here("data", "models", "model3_nb.RData"))

# Get summary of the model
summary(model3_nb)
```

Model output suggests a significant effect of time and a significant interaction between time period and land cover change (Y) but no significant effect of land cover. AIC and BIC values still large. Dispersion parameter = 0.50.

#### Simulate Residuals with DHARMa

```{r simulate residuals}

# Simulate residuals 
model3_nb_simulation <- simulateResiduals(fittedModel = model3_nb)

# Plot simulated residuals
plot(model3_nb_simulation)
```

Simulated residuals deviate significantly from expectations, are overdispersed and have many outliers. The within-group deviations from uniformity are significant. Test for homogeneity of variance is significant.

#### Test for Overdispersion

```{r test for overdispersion}
testDispersion(model3_nb_simulation)
```

#### Test for Zero-Inflation

```{r test for zero inflation}
testZeroInflation(model3_nb_simulation)
```

## Attempt 4: Model 1: Number of occurrences after change by land cover change (Y/N) and SSB ID - NB GAMM

GAMMs seem to only run with Poisson data, which does not fit for our data.

## Attempt 1: Model 2: Number of occurrences after change by land cover change (Y/N), SSB ID and number of occurrences before with offset

```{r prepare df for analyis, include = FALSE, eval = FALSE}

# 1. First period of change: 2000-2006 -------------------------------------------------

# Prepare data for the period 2006-2009
occ_df_before_2000.2006 <- occ_SSB_land_cover |>
  select(V1, gbifID, year, species, land_cover2000, land_cover2006, 
         SSBID, cell_ID, NAME_2) |>
  filter(!is.na(land_cover2000) & !is.na(land_cover2006)) |>
  filter(year >= 1997 & year <= 2000) |>
  mutate(cover_change = if_else(land_cover2000 == land_cover2006, "N", "Y"))

# Calculate number of records for the period 2006-2009
occ_df_before_2000.2006_records <- occ_df_before_2000.2006 |>
  group_by(cell_ID) |>
  summarise(
    ocurrences_before = n(),
    land_cover2000 = first(land_cover2000),
    land_cover2006 = first(land_cover2006),
    cover_change = first(cover_change),
    SSBID = first(SSBID),
    NAME_2 = first(NAME_2)) |>
  mutate(time_period = "2000-2006") |>
  select(-c(land_cover2000, land_cover2006))

# 2. Second period of change: 2006 - 2012 ----------------------------------------------

# Prepare data for the period 2003-2006
occ_df_before_2006.2012 <- occ_SSB_land_cover |>
  select(V1, gbifID, year, species, land_cover2006, land_cover2012, 
         SSBID, cell_ID, NAME_2) |>
  filter(!is.na(land_cover2006) & !is.na(land_cover2012)) |>
  filter(year >= 2003 & year <= 2006) |>
  mutate(cover_change = if_else(land_cover2006 == land_cover2012, "N", "Y"))

# Calculate number of records for the period 2003-2006
occ_df_before_2006.2012_records <- occ_df_before_2006.2012 |>
  group_by(cell_ID) |>
  summarise(
    ocurrences_before = n(),
    land_cover2006 = first(land_cover2006),
    land_cover2012 = first(land_cover2012),
    cover_change = first(cover_change),
    SSBID = first(SSBID),
    NAME_2 = first(NAME_2)) |>
  mutate(time_period = "2006-2012") |>
  select(-c(land_cover2006, land_cover2012))

# 3. Third period of change: 2012 - 2018 ----------------------------------------------

# Prepare data for the period 2009-2012
occ_df_before_2012.2018 <- occ_SSB_land_cover |>
  select(V1, gbifID, year, species, land_cover2012, land_cover2018, 
         SSBID, cell_ID, NAME_2) |>
  filter(!is.na(land_cover2012) & !is.na(land_cover2018)) |>
  filter(year >= 2009 & year <= 2012) |>
  mutate(cover_change = if_else(land_cover2012 == land_cover2018, "N", "Y"))

# Calculate number of records for the period 1997-2000
occ_df_before_2012.2018_records <- occ_df_before_2012.2018 |>
  group_by(cell_ID) |>
  summarise(
    ocurrences_before = n(),
    land_cover2012 = first(land_cover2012),
    land_cover2018 = first(land_cover2018),
    cover_change = first(cover_change),
    SSBID = first(SSBID),
    NAME_2 = first(NAME_2)) |>
  mutate(time_period = "2012-2018") |>
  select(-c(land_cover2012, land_cover2018))

# 4. Combine the above 3 into a single df ----------------------------------------------

occ_df_before_records <- bind_rows(occ_df_before_2000.2006_records,
                                  occ_df_before_2006.2012_records,
                                  occ_df_before_2012.2018_records) |>
  select(-cell_ID) |>
  rename(municipality = NAME_2)


# 5. Combine occ_df_before_records wtih occ_df_after_records ---------------------------

# Full join of the dfs on SSBid and time_period
occ_df_before_after <- full_join(occ_df_after_records,
                                 occ_df_before_records,
                                 by = c("SSBID", "time_period", 
                                        "cover_change", "municipality"))

# Replace NA with 0 for occurrences_before and occurrences_after
occ_df_before_after_for_model <- occ_df_before_after |>
  mutate(ocurrences_after = ifelse(is.na(ocurrences_after), 0, ocurrences_after),
         ocurrences_before = ifelse(is.na(ocurrences_before), 0, ocurrences_before))


# 5. Write dataframe to file -----------------------------------------------------------
save(occ_df_before_after_for_model, file = here::here("data", "derived_data",
                                          "occ_df_before_after_for_model.rda"))

```

### Data Exploration

#### Inspect Data

```{r inspect data}
glimpse(occ_df_before_after)
```

#### Check for Outliers

```{r check outliers}
# Barplot of number of occurrences
ggplot(occ_df_before_after , 
       aes(x = cover_change, y = ocurrences_before, fill = time_period))+
  geom_boxplot()+
  theme_classic()
```

Just as with the occurrences after the land cover change, the occurrences before also have some very high outliers, more so for the pixels where there is no change in land cover.

#### Check Normality

```{r normality before}

# Plot histogram of number of records by time period
occ_df_before_after |>
  filter(ocurrences_before < 100) |>
  ggplot(aes(x = ocurrences_before)) +
  geom_histogram(binwidth = 2, position = "dodge", 
                 alpha = 0.4) +
  facet_grid(time_period ~ ., scales = "free") +
  theme_classic()
```

Distribution not normal.

#### Check Zero Inflation

```{r zero inflation before after}

# Calculate % of rows with values of 0 for number of occurrences
100 * sum(occ_df_before_after$ocurrences_after == 0) / nrow(occ_df_before_after) #0.001
100 * sum(occ_df_before_after$ocurrences_before == 0) / nrow(occ_df_before_after) # 0.007

```

No problems with zero inflation - or so it seems.

#### Check Relationships

```{r check relationship before after}
occ_df_before_after |>
  ggplot(aes(x = ocurrences_before, y = ocurrences_after, fill = cover_change)) +
  geom_point(size = 2) +
  facet_wrap(~time_period) +
  theme_classic()
```

### Model Setup

```{r model 1, include = FALSE, eval = FALSE}

# Run negative binomial model
model5_nb <- glmer.nb(ocurrences_after ~ cover_change * time_period * ocurrences_before + offset(ocurrences_before) + (1 | SSBid),
                      data = occ_df_before_after)

# Save model output to file to save time next time
save(model5_nb, file = here::here("data", "models", "model5_nb.RData"))
```

Error in eval(mc, parent.frame(1L)) : PIRLS loop resulted in NaN value - problem with the offset?
